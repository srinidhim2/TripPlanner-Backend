version: '3.8'
services:
  user-service:
    build:
      context: ./user-management
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "3003:3003"
    # Environment variables now set in Dockerfile
    volumes:
      - ./user-management/uploads:/app/uploads
      - ./user-management/logs:/app/logs
    depends_on:
      - mongo
      - kafka
    networks:
      - tripnet
  
  notification-service:
    build:
      context: ./notification-service   # Adjust to your notification service folder
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "3004:3004"
    volumes:
      - ./notification-service/logs:/usr/src/app/logs
    depends_on:
      - mongo
      - kafka
    networks:
      - tripnet
  mongo:
    image: mongo:6.0
    container_name: mongo
    ports:
      - "27019:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - tripnet
  kafka:
    image: bitnami/kafka:3.6.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on:
      - zookeeper
    networks:
      - tripnet
    
  zookeeper:
    image: bitnami/zookeeper:3.8.1
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - tripnet

  trip-service:
    build:
      context: ./trip-service
      dockerfile: Dockerfile
    container_name: trip-service
    ports:
      - "3005:3005"          # Map exposed port to host port
    volumes:
      - ./trip-service/uploads:/app/uploads    # if you have upload directory
      - ./trip-service/logs:/app/logs          # if you log to file
    depends_on:
      - mongo
      - kafka
    # Note: No 'environment' here since env vars are in Dockerfile
    networks:
      - tripnet

  connect:
    build:
      context: ./kafka-connect
      dockerfile: Dockerfile
    image: tripplanner/kafka-connect:opensearch
    container_name: kafka-connect
    ports:
      - "8083:8083"
    environment:
      - BOOTSTRAP_SERVERS=kafka:9092
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=connect-configs
      - OFFSET_STORAGE_TOPIC=connect-offsets
      - STATUS_STORAGE_TOPIC=connect-status
      - CONNECT_KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter
      - CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE=false
      - CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=false
      - CONNECT_REST_ADVERTISED_HOST_NAME=connect
      - CONNECT_PLUGIN_PATH=/kafka/connect
    depends_on:
      - kafka
    networks:
      - tripnet

  opensearch:
    image: opensearchproject/opensearch:2.9.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - plugins.security.disabled=false
      - OPENSEARCH_USERNAME=admin
      - OPENSEARCH_PASSWORD=admin
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - tripnet

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.9.0
    container_name: opensearch-dashboards
    ports:
      - "5601:5601"
    environment:
      # Connect to OpenSearch over HTTPS (security plugin uses demo certs)
      - OPENSEARCH_HOSTS=https://opensearch:9200
      - OPENSEARCH_USERNAME=admin
      - OPENSEARCH_PASSWORD=admin
      # Allow insecure/demo certificates for local development
      - OPENSEARCH_SSL_VERIFICATIONMODE=none
    depends_on:
      - opensearch
    networks:
      - tripnet

volumes:
  mongo-data:
  opensearch-data:

networks:
  tripnet:
    driver: bridge
